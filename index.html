# -*- coding: utf-8 -*-
''''
echo `# <# <!--`
# ADHUNT v0.1.0
# server, domain, user, password
# $1       $2      $3     $4
# http://www.selfadsi.org/user-attributes-w2k12.htm

function getusers {
    if [ "$#" -eq 0 ]; then
        exec 3<&0 4<&1 
        exec 0</dev/tty
        exec 1>/dev/tty
        printf "\\033c"
        echo "ADHUNT: You are about to dump the domain using ldapsearch"
        read -p "Enter Server host: " server < /dev/tty
        read -p "Enter Server domain eg. dc=example,dc=com: " domain < /dev/tty
        read -p "Enter username: " username < /dev/tty
        read -sp "Enter password (no visible ninja): " password < /dev/tty
        exec 0<&3 3<&-
        exec 1<&4 4<&-
    else
        if [ "$#" -ne 4 ]; then
            echo "adhunt.html <server> <domain> <user> <password>"
            exit 1
        fi

        server=$1
        domain=$2
        username=$3
        password=$4
    fi

    mkdir results

    # server, domain, user, password
    # dc=example,dc=com
    ldapsearch -LLL -x -H "ldap://$server" \
        -D "$username" -w "$password" \
        -b "$domain" -o ldif-wrap=no \
        "(&(objectClass=user)(objectCategory=person))" \
        accountExpires adminDescription adminDisplayName \
        ADsPath altRecipient altRecipientBL \
        authOrig authOrigBL autoReplyMessage \
        badPasswordTime badPwdCount canonicalName \
        Class co comment \
        company countryCode createTimeStamp \
        deletedItemFlags delivContLength deliverAndRedirect \
        department departmentNumber description \
        directReports displayName displayNamePrintable \
        distinguishedName division dLMemRejectPerms \
        dLMemRejectPermsBL dLMemSubmitPerms dLMemSubmitPermsBL \
        employeeID employeeNumber employeeType \
        extensionData extensionAttribute1 extensionAttribute2 \
        extensionAttribute3 extensionAttribute4 extensionAttribute5 \
        extensionAttribute6 extensionAttribute7 extensionAttribute8 \
        extensionAttribute9 extensionAttribute10 extensionAttribute11 \
        extensionAttribute12 extensionAttribute13 extensionAttribute14 \
        extensionAttribute15 facsimileTelephoneNumber garbageCollPeriod \
        givenName homeDirectory homeDrive \
        homeMDB homeMTA homePhone \
        info initials ipPhone \
        isDeleted isRecycled l \
        lastKnownParent lastLogoff lastLogon \
        lastLogonTimestamp legacyExchangeDN lockoutTime \
        logonCount logonHours mail \
        mailNickname manager mDBOverHardQuotaLimit \
        mDBOverQuotaLimit mDBStorageQuota mDBUseDefaults \
        memberOf mobile modifyTimeStamp \
        msCOM-UserPartitionSetLink msDS-User-Account-Control-Computed \
        msDS-UserPasswordExpiryTimeComputed msExchHideFromAddressLists \
        msExchHomeServerName msExchMailboxSecurityDescriptor \
        msExchMasterAccountSID msExchOmaAdminWirelessEnable \
        msExchPoliciesExcluded msExchRecipLimit msExchRequireAuthToSendTo \
        msExchUserAccountControl msNPAllowDialin msNPCallingStationID \
        msNPSavedCallingStationID msRADIUSCallbackNumber \
        msRADIUSFramedIPAddress msRADIUSFramedRoute \
        msRADIUSServiceType msRASSavedCallbackNumber \
        msRASSavedFramedIPAddress msRASSavedFramedRoute \
        msSFU30GidNumber msSFU30HomeDirectory msSFU30LoginShell \
        msSFU30Name msSFU30NisDomain msSFU30Password \
        msSFU30UidNumber name nTSecurityDescriptor \
        objectCategory objectClass objectGUID \
        objectSid otherFacsimileTelephoneNumber otherHomePhone \
        otherIpPhone otherMobile otherPager \
        otherTelephone pager Parent \
        physicalDeliveryOfficeName postalCode postOfficeBox \
        primaryGroupID profilePath protocolSettings \
        proxyAddresses publicDelegates publicDelegatesBL \
        pwdLastSet sAMAccountName scriptPath \
        seeAlso securityProtocol sIDHistory \
        sn st streetAddress \
        submissionContLength telephoneNumber textEncodedORAddress \
        title unauthOrig unauthOrigBL \
        url userAccountControl userCertificate \
        userParameters userPrincipalName userWorkstations \
        uSNChanged uSNCreated whenChanged \
        whenCreated wWWHomePage \
        title name sAMAccountName userPrincipalName \
        adminCount servicePrincipalName telephoneNumber \
        msTsPrimaryDesktop msTSProperty01 msDs-AuthenticatedAtDC \
        userPassword createTimeStamp modifyTimeStamp \
        homePhone department company \
        badPwdCount lockoutTime objectSid \
        lastLogon physicalDeliveryOfficeName \
        profilePath scriptPath homeDirectory \
        homeDrive -E pr=1000/noprompt > results/USERS.ldif

    ldapsearch -LLL -x -H "ldap://$server" -D "$username" -w "$password" -b "$domain" -o ldif-wrap=no "(|(objectClass=organizationalUnit)(objectClass=Group))" \
        adminDescription adminDisplayName ADsPath \
        authOrig authOrigBL canonicalName \
        Class cn createTimeStamp \
        delivContLength description displayName \
        displayNamePrintable distinguishedName dLMemRejectPerms \
        dLMemRejectPermsBL dLMemSubmitPerms dLMemSubmitPermsBL \
        extensionAttribute groupType homeMTA \
        info isDeleted legacyExchangeDN \
        mail mailNickName managedBy \
        member memberOf modifyTimeStamp \
        msExchExpansionServerName msExchHideFromAddressLists msExchHomeServerName \
        msExchRequireAuthToSendTo msSFU30GidNumber msSFU30Name \
        msSFU30NisDomain msSFU30PosixMember name \
        Name nTSecurityDescriptor objectCategory \
        objectClass objectGUID objectSid \
        oOFReplyToOriginator Parent primaryGroupToken \
        proxyAddresses reportToOriginator reportToOwner \
        sAMAccountName telephoneNumber textEncodedORAddress \
        unauthOrig unauthOrigBL uSNChanged \
        uSNCreated whenChanged whenCreated -E pr=1000/noprompt > results/GROUPS.ldif

    ldapsearch -LLL -x -H "ldap://$server" -D "$username" -w "$password" -b "$domain" -o ldif-wrap=no "(&(objectClass=computer))" -E pr=1000/noprompt > results/COMPUTERS.ldif

    # Follow the gPCFileSysPath to get contents of policies. Login to SYSVOL volumes.
    ldapsearch -LLL -x -H "ldap://$server" \
        -D "$username" -w "$password" \
        -b "CN=Policies,CN=System,$domain" \
        -o ldif-wrap=no \
        "(objectClass=groupPolicyContainer)" \
        displayName cn name gPCFileSysPath gPCFunctionalityVersion \
        gPCMachineExtensionNames gPCUserExtensionNames \
        whenCreated whenChanged uSNCreated uSNChanged \
        objectGUID objectSid \
        > results/GPOS.ldif
}

# server, domain, user, password, outfile
getusers $1 $2 $3 $4
exit 1
Yes, the bash script stopped working here.

In order to run this script as powershell, just run it like so:
iex(gc -path adhunt.html -raw)
# -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">§
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADHUNT version 0.1.0</title>
    <style>
        :root {
            --bg-color-light: #ffffff;
            --text-color-light: #000000;
            --bg-color-dark: #012456;
            --text-color-dark: #ffffff;
        }

        body {
            font-family: monospace;
            font-size: 1px;
            transition: 1s;
        }

        body.light-mode {
            background-color: var(--bg-color-light);
            color: var(--text-color-light);
        }

        body.dark-mode {
            background-color: var(--bg-color-dark);
            color: var(--text-color-dark);
        }

        body.light-mode input,
        body.light-mode button {
            background: var(--bg-color-light);
            color: var(--text-color-light);
            border: 1px solid rgb(224, 224, 224);
        }

        body.dark-mode input,
        body.dark-mode button {
            background: var(--bg-color-dark);
            color: var(--text-color-dark);
            border: 1px solid rgb(232, 229, 255);
        }

        #date, h2 {
            font-size: 32px;
        }

        h2 {
            margin-bottom: 8px;
        }

        .container, .user, p {
            font-size: 14px;
        }

        .container {
            width: 100%;
        }

        .output {
            max-width: 100%;
            width: 100%;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
        }

        p {
            margin: 2px 0;
            word-wrap: break-word;
        }

        .user, .group, .computer, .gpo {
            width: 33%;
            word-wrap: wrap;
        }

        summary, details {
            cursor: pointer;
        }

        .userAccountControl, .servicePrincipalName {
            font-weight: bold;
            color: red;
        }

        .pwdLastSet {
            font-weight: bold;
            color: rgb(105, 105, 255);
        }

        .lastLogon, .userCertificate, .memberOf {
            font-weight: bold;
            color: rgb(36, 196, 36);
        }

        .userPrincipalName {
            font-weight: bold;
            color: rgb(182, 29, 196);
        }

        input, button {
            padding: 10px 20px;
            height: 45px;
        }

        button {
            font-size: 16px;
            min-width: 140px;
            cursor: pointer;
        }

        .legend {
            margin-top: 16px;
        }

        #controls-checks {
            display: flex;
            gap: 8px;
            align-items: center;
            text-align: center;
        }

        .check {
            cursor: pointer;
            font-weight: 800;
        }

        button:hover {
            filter: brightness(1.2);
            transition: 0.3s;
        }

        #controls {
            margin-bottom: 16px;
        }

        .visible {
            display: block;
        }

        .hidden {
            display: none;
        }

        a {
            color: rgb(255, 125, 3);
            font-weight: bold;
        }

        #credits {
            margin-bottom: 8px;
        }

        .progress {
            margin-top: 16px;
            letter-spacing: 2px;
        }
        .panel, #controls-filters {
            display: flex;
            gap: 16px;
        }

        .list-entry {
            margin-bottom: 16px;
            margin-top: 8px
        }

        strong {
            padding-right: 4px;
        }

    </style>
</head>
<body class="dark-mode">
    <div class="container">
        <div id="credits">
            ADHUNT v0.1.0 
            <a href="https://github.com/krystianbajno/ADHUNT">https://github.com/krystianbajno/ADHUNT</a> 
            © Krystian Bajno 2024 
        </div>
        <div id="date"></div>
        <div id="controls">
            <div id="controls-checks">
                <input id="users-check" checked type="checkbox"/><label class="check" for="users-check">Users</label>
                <input id="groups-check" type="checkbox"/><label class="check" for="groups-check">Groups</label>
                <input id="computers-check" type="checkbox"/><label class="check" for="computers-check">Computers</label>    
                <input id="gpos-check" type="checkbox"/><label class="check" for="gpos-check">Group Policies</label>    
            </div>
            <div id="controls-filters">
                <button id="toggleButton">☀️</button>
                <input type="text" id="filterInput" placeholder="Enter filter text here"/>
            </div>
        </div>
        <div id="users-panel" class="visible">
            <h1>Users</h1>
            <div class="panel">
                <button id="saveButtonUsers">Save .csv</button>
                <input type="file" id="usersFileInput"/>
                <div class="progress" id="usersProgress"></div>
            </div>
            <div class="output" id="output-users"></div>
        </div>
        <div id="groups-panel" class="hidden">
            <h1>Groups</h1>
            <div class="panel">
                <button id="saveButtonGroups">Save .csv</button>
                <input type="file" id="groupsFileInput"/>
                <div class="progress" id="groupsProgress"></div>
            </div>
            <div class="output" id="output-groups"></div>
        </div>
        <div id="computers-panel" class="hidden">
            <h1>Computers</h1>
            <div class="panel">
                <button id="saveButtonComputers">Save .csv</button>
                <input type="file" id="computersFileInput"/>
                <div class="progress" id="computersProgress"></div>
            </div>
            <div class="output" id="output-computers"></div>
        </div>
        <div id="gpos-panel" class="hidden">
            <h1>Group Policies</h1>
            <div class="panel">
                <button id="saveButtonGpos">Save .csv</button>
                <input type="file" id="gposFileInput"/>
                <div class="progress" id="gposProgress"></div>
            </div>
            <div class="output" id="output-gpos"></div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dataStore = {
                allUsers: [],
                displayedUsers: [],
                allGroups: [],
                displayedGroups: [],
                allComputers: [],
                displayedComputers: [],
                allGpos: [],
                displayedGpos: []
            };

            const pagination = {
                ITEMS_PER_LOAD: 20,
                userLoadIndex: 0, 
                groupLoadIndex: 0, 
                computerLoadIndex: 0, 
                gpoLoadIndex: 0
            };
            
            const elements = {
                usersCheck: document.getElementById('users-check'),
                groupsCheck: document.getElementById('groups-check'),
                computersCheck: document.getElementById('computers-check'),
                gposCheck: document.getElementById("gpos-check"),
                usersPanel: document.getElementById('users-panel'),
                groupsPanel: document.getElementById('groups-panel'),
                saveButtonUsers: document.getElementById('saveButtonUsers'),
                saveButtonGroups: document.getElementById('saveButtonGroups'),
                saveButtonComputers: document.getElementById('saveButtonComputers'),
                saveButtonGpos: document.getElementById('saveButtonGpos'),
                computersPanel: document.getElementById('computers-panel'),
                gposPanel: document.getElementById('gpos-panel'),
                usersProgress: document.getElementById('usersProgress'),
                groupsProgress: document.getElementById('groupsProgress'),
                computersProgress: document.getElementById('computersProgress'),
                gposProgress: document.getElementById('gposProgress'),
                filterInput: document.getElementById('filterInput'),
                usersFileInput: document.getElementById('usersFileInput'),
                groupsFileInput: document.getElementById('groupsFileInput'),
                computersFileInput: document.getElementById('computersFileInput'),
                gposFileInput: document.getElementById('gposFileInput'),
                outputUsers: document.getElementById('output-users'),
                outputGroups: document.getElementById('output-groups'),
                outputComputers: document.getElementById('output-computers'),
                outputGpos: document.getElementById('output-gpos'),
                date: document.getElementById('date'),
                toggleDarkmodeButton: document.getElementById('toggleButton')
            };

            const inputIdToDataStoreKeys = {
                'usersFileInput': { all: 'allUsers', displayed: 'displayedUsers' },
                'groupsFileInput': { all: 'allGroups', displayed: 'displayedGroups' },
                'computersFileInput': { all: 'allComputers', displayed: 'displayedComputers' },
                'gposFileInput': { all: 'allGpos', displayed: 'displayedGpos' }
            };

            function togglePanelVisibility(checkbox, panel) {
                panel.className = checkbox.checked ? "visible" : "hidden";
            }

            function handleFileUpload(event, output) {
                const file = event.target.files[0];

                if (file && file.type === 'application/json') {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        const data = JSON.parse(e.target.result);
                        const dataStoreKeys = inputIdToDataStoreKeys[event.target.id];

                        dataStore[dataStoreKeys.all] = data;
                        dataStore[dataStoreKeys.displayed] = [...data];
                        applyFilter();
                    };
                    
                    reader.onerror = () => showError(output, 'Error loading file.');
                    reader.readAsText(file);

                } else {
                    showError(output, 'Please upload a valid JSON file.');
                }
            }

            function updateProgress() {
                elements.usersProgress.textContent = `Showing ${dataStore.displayedUsers.length} of ${dataStore.allUsers.length} users`;
                elements.groupsProgress.textContent = `Showing ${dataStore.displayedGroups.length} of ${dataStore.allGroups.length} groups`;
                elements.computersProgress.textContent = `Showing ${dataStore.displayedComputers.length} of ${dataStore.allComputers.length} computers`;
                elements.gposProgress.textContent = `Showing ${dataStore.displayedGpos.length} of ${dataStore.allGpos.length} GPOs`;
            }

            function applyFilter() {
                const query = elements.filterInput.value.toLowerCase();
                window.location.hash = query;
                
                dataStore.displayedUsers = filterData(dataStore.allUsers, query);
                dataStore.displayedGroups = filterData(dataStore.allGroups, query);
                dataStore.displayedComputers = filterData(dataStore.allComputers, query);
                dataStore.displayedGpos = filterData(dataStore.allGpos, query);

                pagination.userLoadIndex = 0;
                pagination.groupLoadIndex = 0;
                pagination.computerLoadIndex = 0;
                pagination.gpoLoadIndex = 0;

                elements.outputUsers.innerHTML = '';
                elements.outputGroups.innerHTML = '';
                elements.outputComputers.innerHTML = '';
                elements.outputGpos.innerHTML = '';

                updateProgress();

                loadMoreItems(elements.outputUsers, dataStore.displayedUsers, "user", pagination.userLoadIndex);
                loadMoreItems(elements.outputGroups, dataStore.displayedGroups, "group", pagination.groupLoadIndex);
                loadMoreItems(elements.outputComputers, dataStore.displayedComputers, "computer", pagination.computerLoadIndex);
                loadMoreItems(elements.outputGpos, dataStore.displayedGpos, "gpo", pagination.gpoLoadIndex);
            }

            function filterData(data, query) {
                const terms = query.toLowerCase().split(/\s+/);
            
                return data.filter(item => 
                    terms.every(term => 
                        Object.keys(item).some(key => 
                            item[key] && item[key].toString().toLowerCase().includes(term)
                        )
                    )
                );
            }

            function sanitizeHtml(html) {
                const temp = document.createElement('div');
                temp.textContent = html;
                return temp.innerHTML;
            }

            function sanitizeText(text) {
                return text.replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;")
                    .replace(/`/g, "&#x60;")
                    .replace(/\(/g, "&#40;")
                    .replace(/\)/g, "&#41;")
                    .replace(/\//g, "&#x2F;")
                    .replace(/\\/g, "&#x5C;");
            }

            function createElementWithText(tag, text, className = '') {
                const element = document.createElement(tag);
                element.textContent = text;
                if (className) element.className = className;
                return element;
            }

            function createDetailElement(key, value) {
                const details = document.createElement('details');
                const summary = document.createElement('summary');
                const strongSummary = createElementWithText('strong', key, key);
                summary.appendChild(strongSummary);
                
                for (const val of value) {
                    const detailsContent = createElementWithText('p', sanitizeHtml(val), "list-entry");
                    details.appendChild(detailsContent);
                }

                details.appendChild(summary);
                
                return details;
            }

            function createKeyValueElement(key, value) {
                const p = document.createElement('p');
                const strongKey = createElementWithText('strong', `${key}:`, sanitizeText(key));
                const textValue = document.createTextNode(`${sanitizeHtml(value)}`);
                
                p.appendChild(strongKey);
                p.appendChild(textValue);
                
                return p;
            }

            function loadMoreItems(output, data, type, startIndex) {                
                if (data.length === 0) {
                    output.textContent = `No ${type}s found. Load a file or refine your filters.`;
                    return;
                }

                const endIndex = Math.min(startIndex + pagination.ITEMS_PER_LOAD, data.length);
                
                data.slice(startIndex, endIndex).forEach(item => {
                    const div = document.createElement('div');
                    div.className = type;

                    div.appendChild(createElementWithText('h2', sanitizeHtml(item.name)));

                    Object.entries(item).forEach(([key, value]) => {
                        if (["userCertificate", "member", "memberOf", "servicePrincipalName"].includes(key)) {
                            div.appendChild(createDetailElement(key, value));
                        } else {
                            div.appendChild(createKeyValueElement(key, value));
                        }
                    });

                    output.appendChild(div);
                })

                if (endIndex < data.length) {
                    const observerTarget = createElementWithText('div', '', 'observer-target');
                    output.appendChild(observerTarget);

                    const observer = new IntersectionObserver(entries => {
                        if (entries[0].isIntersecting) {
                            observer.unobserve(observerTarget);
                            observerTarget.remove();
                            
                            switch (type) {
                                case 'user': pagination.userLoadIndex = endIndex; break;
                                case 'group': pagination.groupLoadIndex = endIndex; break;
                                case 'computer': pagination.computerLoadIndex = endIndex; break;
                                case 'gpo': pagination.gpoLoadIndex = endIndex; break;
                            }
                            
                            loadMoreItems(output, data, type, endIndex);
                        }
                    }, { threshold: 0.1 });

                    observer.observe(observerTarget);
                }
            }

            function showError(output, message) {
                output.textContent = message;
                console.error(message);
            }

            function convertToCSV(json) {
                const headers = Object.keys(json[0]);
                const csvRows = [headers.join(',')];
                for (const row of json) {
                    const values = headers.map(header => `"${('' + row[header]).replace(/"/g, '\\"')}"`);
                    csvRows.push(values.join(','));
                }
                return csvRows.join('\n');
            }

            function downloadCSV(data, filename) {
                const csv = convertToCSV(data);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.hidden = true;
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }

            elements.saveButtonUsers.addEventListener('click', () => downloadCSV(displayedUsers, 'users.csv'));
            elements.saveButtonGroups.addEventListener('click', () => downloadCSV(displayedGroups, 'groups.csv'));
            elements.saveButtonComputers.addEventListener('click', () => downloadCSV(displayedComputers, 'computers.csv'));
            elements.saveButtonGpos.addEventListener('click', () => downloadCSV(displayedGpos, 'computers.csv'));

            elements.usersFileInput.addEventListener('change', (e) => handleFileUpload(e, elements.outputUsers));
            elements.groupsFileInput.addEventListener('change', (e) => handleFileUpload(e, elements.outputGroups));
            elements.computersFileInput.addEventListener('change', (e) => handleFileUpload(e, elements.outputComputers));
            elements.gposFileInput.addEventListener('change', (e) => handleFileUpload(e, elements.outputGpos));

            elements.filterInput.addEventListener('change', applyFilter);
            
            addEventListener("hashchange", (event) => {
                elements.filterInput.value = decodeURI(location.hash.substring(1))
                applyFilter()
            });

            [elements.usersCheck, elements.groupsCheck, elements.computersCheck, elements.gposCheck].forEach((checkbox, index) => {
                const panel = [elements.usersPanel, elements.groupsPanel, elements.computersPanel, elements.gposPanel][index];
                togglePanelVisibility(checkbox, panel);
                checkbox.addEventListener('change', () => togglePanelVisibility(checkbox, panel));
            });

            document.body.classList.toggle('dark-mode', window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);

            elements.toggleDarkmodeButton.addEventListener('click', () => {
                document.body.classList.toggle('light-mode');
                document.body.classList.toggle('dark-mode');
            });

            elements.date.textContent = new Date().toLocaleString();
        });
    </script>
<!--
'''
import argparse
import base64
import json
import datetime
import os
import re
import struct
import sys

uac_values = {
    512: 'Enabled',
    514: 'Disabled',
    528: 'Enabled - Locked Out',
    530: 'Disabled - Locked Out',
    544: 'Enabled - Password Not Required',
    546: 'Disabled - Password Not Required',
    560: 'Enabled - Password Not Required - Locked Out',
    640: 'Enabled - Encrypted Text Password Allowed',
    2048: 'Enabled - Interdomain Trust Account',
    2050: 'Disabled - Interdomain Trust Account',
    2080: 'Enabled - Interdomain Trust Account - Password Not Required',
    2082: 'Disabled - Interdomain Trust Account - Password Not Required',
    4096: 'Enabled - Workstation Trust Account',
    4098: 'Disabled - Workstation Trust Account',
    4128: 'Enabled - Workstation Trust Account - Password Not Required',
    4130: 'Disabled - Workstation Trust Account - Password Not Required',
    8192: 'Enabled - Server Trust Account',
    8194: 'Disabled - Server Trust Account',
    66048: 'Enabled - Password Does Not Expire',
    66050: 'Disabled - Password Does Not Expire',
    66056: 'Enabled - Password Does Not Expire - HomeDir Required',
    66064: 'Enabled - Password Does Not Expire - Locked Out',
    66066: 'Disabled - Password Does Not Expire - Locked Out',
    66080: 'Enabled - Password Does Not Expire - Password Not Required',
    66082: 'Disabled - Password Does Not Expire - Password Not Required',
    66176: 'Enabled - Password Does Not Expire - Encrypted Text Password Allowed',
    69632: 'Enabled - Workstation Trust Account - Dont Expire Password',
    131584: 'Enabled - Majority Node Set (MNS) Account',
    131586: 'Disabled - Majority Node Set (MNS) Account',
    131600: 'Enabled - Majority Node Set (MNS) Account - Locked Out',
    197120: 'Enabled - Majority Note Set (MNS) Account - Password Does Not Expire',
    262656: 'Enabled - Smartcard Required',
    262658: 'Disabled - Smartcard Required',
    28416: 'Enabled - Workstation Trust Account - Trusted for Delegation - Password Not Required',
    528418: 'Disabled - Workstation Trust Account - Trusted for Delegation - Password Not Required',
    532480: 'Server Trust Account - Trusted For Delegation (Domain Controller)',
    532482: 'Disabled - Server Trust Account - Trusted For Delegation (Domain Controller)',
    590336: 'Enabled - Password Does Not Expire - Trusted For Delegation',
    590338: 'Disabled - Password Does Not Expire - Trusted For Delegation',
    1049088: 'Enabled - Not Delegated',
    1049090: 'Disabled - Not Delegated',
    1114624: 'Enabled - Password Does Not Expire - Not Delegated',
    1114626: 'Disabled - Password Does Not Expire - Not Delegated',
    1114656: 'Enabled - Password Not Required - Password Does Not Expire - Not Delegated',
    2097664: 'Enabled - Use DES Key Only',
    2163200: 'Enabled - Password Does Not Expire - Use DES Key Only',
    2687488: 'Enabled - Password Does Not Expire - Trusted For Delegation - Use DES Key Only',
    3211776: 'Enabled - Password Does Not Expire - Not Delegated - Use DES Key Only',
    4194816: 'Enabled - PreAuthorization Not Required',
    4260352: 'Enabled - Password Does Not Expire - PreAuthorization Not Required',
    4260354: 'Disabled - Password Does Not Expire - PreAuthorization Not Required',
    16781312: 'Enabled - Workstation Trust Account - Trusted to Authenticate For Delegation',
    16843264: 'Enabled - Password Does Not Expire - Trusted to Authenticate For Delegation',
    83890176: 'Enabled - Server Trust Account - Trusted For Delegation - (Read-Only Domain Controller (RODC))'
}

def is_base64(s):
    if len(s) % 4 != 0:
        return False
    
    base64_pattern = re.compile(r'^[A-Za-z0-9+/]+={0,2}$')
    if not base64_pattern.match(s):
        return False
    
    try:
        base64.b64decode(s, validate=True)
        return True
    except Exception:
        return False

def decode_base64(s):
    try:
        decoded_bytes = base64.b64decode(s)
        return decoded_bytes.decode('utf-8')
    except Exception as e:
        return s

def convert_domain_to_dn(domain):
    return ",".join(f"dc={part}" for part in domain.split("."))

def ad_timestamp_to_datetime(ad_timestamp):
    try:
        ad_timestamp = int(ad_timestamp)
        
        windows_epoch_start = datetime.datetime(1601, 1, 1)
        
        max_datetime = datetime.datetime(9999, 12, 31, 23, 59, 59)
        max_timestamp = (max_datetime - windows_epoch_start).total_seconds() * 10**7
        
        if ad_timestamp < 0:
            ad_timestamp = 0
        elif ad_timestamp > max_timestamp:
            ad_timestamp = int(max_timestamp)
        
        seconds = ad_timestamp / 10**7
        
        return (windows_epoch_start + datetime.timedelta(seconds=seconds)).isoformat()
    except Exception as e:
        return ad_timestamp



def convert_sid(sid):
    if isinstance(sid, str):
        sid = sid.encode()

    if sys.version_info.major < 3:
        revision = ord(sid[0])
    else:
        revision = sid[0]

    if sys.version_info.major < 3:
        number_of_sub_ids = ord(sid[1])
    else:
        number_of_sub_ids = sid[1]

    iav = struct.unpack('>Q', b'\x00\x00' + sid[2:8])[0]
    sub_ids = [struct.unpack('<I', sid[8 + 4 * i:12 + 4 * i])[0]
               for i in range(number_of_sub_ids)]

    return 'S-{0}-{1}-{2}'.format(revision, iav, '-'.join([
        str(sub_id)
        for sub_id in sub_ids
    ]))
    
def convert_guid(guid):
    order = [4, 3, 2, 1, 6, 5, 8, 7, 9, 10, 11, 12, 13, 14, 15, 16]
    result = ''

    for i in order:
        result += '%x' % guid[i-1]

    return result

def parse_key_value(key, value):
    if key in [
        "lastLogon",
        "pwdLastSet",
        "accountExpires",
        "msDS-UserPasswordExpiryTimeComputed",
        "ms-Mcs-AdmPwdExpirationTime",
        "badPasswordTime",
        "lastLogonTimestamp"
    ]:
        return ad_timestamp_to_datetime(value)
    
    if key in ["userAccountControl"]:
        return f"{value} - {uac_values.get(int(value))}"
    
    if key in ["objectGUID"]:
        guid =  base64.b64decode(value)
        return f"{convert_guid(guid)}"
    
    if key in ["objectSid"]:
        sid = base64.b64decode(value)
        return f"{convert_sid(sid)}"

    if not type(value) in (tuple, list):
        if is_base64(value):
            if key not in [
                "userCertificate",
                "cn", 
                "isCriticalSystemObject", 
                "msExchHideFromAddressLists", 
                "logonCount", 
                "mDBUseDefaults"
            ]:
                return decode_base64(value)

    return value

# todo 
def dump_domain(results_dir=None):
    print("NOT_IMPLEMENTED")

def convert_bloodhound(results_dir=None):
    print("NOT_IMPLEMENTED")

def parse_ldif(results_dir):
    entries = {
        "USERS.ldif": [],
        "COMPUTERS.ldif": [],
        "GROUPS.ldif": [],
        "GPOS.ldif": []
    }

    for filename in os.listdir(results_dir):
        if "ldif" not in filename:
            continue
        
        file_path = os.path.join(results_dir, filename)
        try:
            with open(file_path, "r") as file:
                blocks = file.read().strip().split('\n\n')
        except FileNotFoundError:
            print(f"[!] Specified file {filename} was not found")
            continue
        
        for block in blocks:
            entry = {}
            for line in block.split('\n'):
                key, value = map(str.strip, line.split(':', 1))
                value = value.strip(": ")
                if key in ["memberOf", "dsCorePropagationData", "member", "objectClass", "servicePrincipalName", "userCertificate"]:
                    entry.setdefault(key, []).append(value)
                else:
                    entry[key] = value
            
            for tag in entries:
                if tag in filename:
                    entries[tag].append(entry)
                    break

    for entry_list in entries.values():
        for entry in entry_list:
            entry.update({key: parse_key_value(key, value) for key, value in entry.items()})

    for key, entry_list in entries.items():
        json_file = os.path.join(results_dir, key.replace('ldif', 'json').upper())
        
        with open(json_file, "w") as fh:
            print(f"+ {json_file}")
            json.dump(entry_list, fh, indent=4)

    print("+ Finished")
    
def interactive_mode():
    print("\033c", end="")
    sys.stdin = open('/dev/tty') 

    choice = ""
    while choice not in ["ldif", "dump", "bloodhound"]:
        choice = input("ADHUNT: Do you want to dump the domain, convert BloodHound or parse LDIF? [ld]if/[du]mp/[bl]oodhound: ").strip().lower()
        if choice in "dump":
            dump_domain()
            return
        elif choice in "ldif":
            print("ADHUNT: You are about to parse LDIF into JSON files.")
            results_dir = input("Please enter the results directory: ")
            parse_ldif(results_dir=results_dir)
            return
        elif choice in "bloodhound":
            print("ADHUNT: You are about to convert BloodHound into JSON files.")
            results_dir = input("Please enter the BloodHound results directory: ")
            convert_bloodhound(results_dir=results_dir)
            return
        else:
            print("Invalid choice. Please enter 'ldif' or 'dump'.")

def command_line_mode():
    parser = argparse.ArgumentParser(description='Parse ldapsearch output into JSON.')
    parser.add_argument('results_dir', help='Results directory')
    parser.add_argument("--dump", action="store_true", default=False, help='Dump domain data')
    parser.add_argument("--bloodhound", action="store_true", default=False, help='Convert BloodHound data')

    args = parser.parse_args()

    if args.bloodhound:
        convert_bloodhound(args.results_dir)
        return

    if args.dump:
        dump_domain(results_dir=args.results_dir)
    else:
        parse_ldif(results_dir=args.results_dir)

def main():
    if not os.isatty(0):
        interactive_mode()
    else:
        command_line_mode()

if __name__ == "__main__":
    main()
    
''''
Yes, this line is a limbo. PowerShell below. The powershell script will try to get the current user credentials.
#>
$uac_values = @{
    512 = 'Enabled'
    514 = 'Disabled'
    528 = 'Enabled - Locked Out'
    530 = 'Disabled - Locked Out'
    544 = 'Enabled - Password Not Required'
    546 = 'Disabled - Password Not Required'
    560 = 'Enabled - Password Not Required - Locked Out'
    640 = 'Enabled - Encrypted Text Password Allowed'
    2048 = 'Enabled - Interdomain Trust Account'
    2050 = 'Disabled - Interdomain Trust Account'
    2080 = 'Enabled - Interdomain Trust Account - Password Not Required'
    2082 = 'Disabled - Interdomain Trust Account - Password Not Required'
    4096 = 'Enabled - Workstation Trust Account'
    4098 = 'Disabled - Workstation Trust Account'
    4128 = 'Enabled - Workstation Trust Account - Password Not Required'
    4130 = 'Disabled - Workstation Trust Account - Password Not Required'
    8192 = 'Enabled - Server Trust Account'
    8194 = 'Disabled - Server Trust Account'
    66048 = 'Enabled - Password Does Not Expire'
    66050 = 'Disabled - Password Does Not Expire'
    66056 = 'Enabled - Password Does Not Expire - HomeDir Required'
    66064 = 'Enabled - Password Does Not Expire - Locked Out'
    66066 = 'Disabled - Password Does Not Expire - Locked Out'
    66080 = 'Enabled - Password Does Not Expire - Password Not Required'
    66082 = 'Disabled - Password Does Not Expire - Password Not Required'
    66176 = 'Enabled - Password Does Not Expire - Encrypted Text Password Allowed'
    69632 = 'Enabled - Workstation Trust Account - Dont Expire Password'
    131584 = 'Enabled - Majority Node Set (MNS) Account'
    131586 = 'Disabled - Majority Node Set (MNS) Account'
    131600 = 'Enabled - Majority Node Set (MNS) Account - Locked Out'
    197120 = 'Enabled - Majority Note Set (MNS) Account - Password Does Not Expire'
    262656 = 'Enabled - Smartcard Required'
    262658 = 'Disabled - Smartcard Required'
    28416 = 'Enabled - Workstation Trust Account - Trusted for Delegation - Password Not Required'
    528418 = 'Disabled - Workstation Trust Account - Trusted for Delegation - Password Not Required'
    532480 = 'Server Trust Account - Trusted For Delegation (Domain Controller)'
    532482 = 'Disabled - Server Trust Account - Trusted For Delegation (Domain Controller)'
    590336 = 'Enabled - Password Does Not Expire - Trusted For Delegation'
    590338 = 'Disabled - Password Does Not Expire - Trusted For Delegation'
    1049088 = 'Enabled - Not Delegated'
    1049090 = 'Disabled - Not Delegated'
    1114624 = 'Enabled - Password Does Not Expire - Not Delegated'
    1114626 = 'Disabled - Password Does Not Expire - Not Delegated'
    1114656 = 'Enabled - Password Not Required - Password Does Not Expire - Not Delegated'
    2097664 = 'Enabled - Use DES Key Only'
    2163200 = 'Enabled - Password Does Not Expire - Use DES Key Only'
    2687488 = 'Enabled - Password Does Not Expire - Trusted For Delegation - Use DES Key Only'
    3211776 = 'Enabled - Password Does Not Expire - Not Delegated - Use DES Key Only'
    4194816 = 'Enabled - PreAuthorization Not Required'
    4260352 = 'Enabled - Password Does Not Expire - PreAuthorization Not Required'
    4260354 = 'Disabled - Password Does Not Expire - PreAuthorization Not Required'
    16781312 = 'Enabled - Workstation Trust Account - Trusted to Authenticate For Delegation'
    16843264 = 'Enabled - Password Does Not Expire - Trusted to Authenticate For Delegation'
    83890176 = 'Enabled - Server Trust Account - Trusted For Delegation - (Read-Only Domain Controller (RODC))'
}

function Is-Base64Encoded($string) {
    if ($string.Length % 4 -ne 0) { return $false }
    $base64Pattern = '^[A-Za-z0-9+/=]+$'
    if ($string -notmatch $base64Pattern) { return $false }
    try {
        [System.Convert]::FromBase64String($string) | Out-Null
        return $true
    } catch {
        return $false
    }
}

function Decode-Base64($string) {
    try {
        [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($string))
    } catch {
        return $string
    }
}

function Convert-ADTimestampToDateTime($adTimestamp) {
    try {
        $seconds = [int]$adTimestamp / 10**7
        $windowsEpochStart = [datetime]'1601-01-01T00:00:00Z'
        ($windowsEpochStart + [timespan]::FromSeconds($seconds)).ToString('o')
    } catch {
        return $adTimestamp
    }
}

function Parse-KeyValue($key, $value) {
    if ($key -in @("lastLogon", "pwdLastSet", "accountExpires", "badPasswordTime", "lastLogonTimestamp")) {
        return Convert-ADTimestampToDateTime $value
    }
    if ($key -eq "userAccountControl") {
        return "$value - $($uac_values[$value])"
    }
    if (-not $value -is [array]) {
        if (Is-Base64Encoded $value) {
            if ($key -ne "userCertificate") {
                return Decode-Base64 $value
            }
        }
    }
    return $value
}

function Convert-LdapDataToJson($ldapObjects, $outputFile) {
    $results = @()
    foreach ($obj in $ldapObjects) {
        $entry = @{}
        foreach ($key in $obj.PropertyNames) {
            $value = $obj.Properties[$key]
            if ($value.Count -eq 1) {
                $entry[$key] = Parse-KeyValue $key $value[0]
            } else {
                $entry[$key] = $value | ForEach-Object { Parse-KeyValue $key $_ }
            }
        }
        $results += $entry
    }
    $results | ConvertTo-Json -Depth 10 | Out-File -FilePath $outputFile
}

function Get-LdapData {
    param(
        [string]$server,
        [string]$domain,
        [string]$username,
        [string]$password
    )

    $baseDN = "LDAP://$server"
    $credential = New-Object System.Management.Automation.PSCredential ($username, (ConvertTo-SecureString $password -AsPlainText -Force))

    $root = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$baseDN, "", [System.DirectoryServices.SearchScope]::Subtree)
    $root.Properties.PropertyNames | ForEach-Object { 
        $root.Properties[$_].Add([System.Collections.ArrayList]::new())
    }

    $root.Filter = "(&(objectClass=user)(objectCategory=person))"
    $users = $root.FindAll()
    Convert-LdapDataToJson -ldapObjects $users -outputFile "results/USERS.json"

    $root.Filter = "(&(objectClass=group))"
    $groups = $root.FindAll()
    Convert-LdapDataToJson -ldapObjects $groups -outputFile "results/GROUPS.json"

    $root.Filter = "(&(objectClass=computer))"
    $computers = $root.FindAll()
    Convert-LdapDataToJson -ldapObjects $computers -outputFile "results/COMPUTERS.json"

    $root.Filter = "(&(objectClass=groupPolicyContainer))"
    $gpos = $root.FindAll()
    Convert-LdapDataToJson -ldapObjects $gpos -outputFile "results/GPOS.json"
}

$server = Read-Host "Enter Server host"
$domain = Read-Host "Enter Server domain (e.g., dc=example,dc=com)"
$username = Read-Host "Enter username"
$password = Read-Host "Enter password (hidden)"

New-Item -Path "results" -ItemType Directory -Force | Out-Null

Get-LdapData -server $server -domain $domain -username $username -password $password
<#'''#>
